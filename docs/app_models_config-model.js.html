<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>app/models/config-model.js - Enketo Express</title>
    
    <meta name="description" content="The full-fledged Enketo web application for the ODK ecosystem" />
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/enketo/enketo-express" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h2><a href="https://github.com/enketo/enketo-express/blob/master/CHANGELOG.md" target="_blank" class="menu-item" id="change-log" >Change log</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-00-getting-started.html">Getting started</a></li><li><a href="tutorial-10-configure.html">Configure</a></li><li><a href="tutorial-20-update.html">Update</a></li><li><a href="tutorial-30-develop.html">Develop</a></li><li><a href="tutorial-60-authentication-and-security.html">Authentication and Security</a></li><li><a href="tutorial-70-browser-support.html">Browser support</a></li><li><a href="tutorial-80-comments.html">Comment Feature</a></li><li><a href="tutorial-90-duplicates.html">Duplicate Bug</a></li></ul><h3>Modules</h3><ul><li><a href="module-account-model.html">account-model</a><ul class='methods'><li data-type='method'><a href="module-account-model.html#.check">check</a></li><li data-type='method'><a href="module-account-model.html#.get">get</a></li><li data-type='method'><a href="module-account-model.html#~_getAccount">_getAccount</a></li><li data-type='method'><a href="module-account-model.html#~_getHardcodedAccount">_getHardcodedAccount</a></li><li data-type='method'><a href="module-account-model.html#~_getServer">_getServer</a></li><li data-type='method'><a href="module-account-model.html#~_isAllowed">_isAllowed</a></li><li data-type='method'><a href="module-account-model.html#~_stripProtocol">_stripProtocol</a></li></ul></li><li><a href="module-api-controller.html">api-controller</a></li><li><a href="module-api-v1-controller.html">api-v1-controller</a><ul class='methods'><li data-type='method'><a href="module-api-v1-controller.html#~_generateQueryString">_generateQueryString</a></li><li data-type='method'><a href="module-api-v1-controller.html#~_generateWebformUrls">_generateWebformUrls</a></li><li data-type='method'><a href="module-api-v1-controller.html#~_render">_render</a></li><li data-type='method'><a href="module-api-v1-controller.html#~_setIframe">_setIframe</a></li><li data-type='method'><a href="module-api-v1-controller.html#~_setQuotaUsed">_setQuotaUsed</a></li><li data-type='method'><a href="module-api-v1-controller.html#~_setReturnQueryParam">_setReturnQueryParam</a></li><li data-type='method'><a href="module-api-v1-controller.html#~authCheck">authCheck</a></li><li data-type='method'><a href="module-api-v1-controller.html#~cacheInstance">cacheInstance</a></li><li data-type='method'><a href="module-api-v1-controller.html#~deactivateSurvey">deactivateSurvey</a></li><li data-type='method'><a href="module-api-v1-controller.html#~getExistingSurvey">getExistingSurvey</a></li><li data-type='method'><a href="module-api-v1-controller.html#~getList">getList</a></li><li data-type='method'><a href="module-api-v1-controller.html#~getNewOrExistingSurvey">getNewOrExistingSurvey</a></li><li data-type='method'><a href="module-api-v1-controller.html#~getNumber">getNumber</a></li><li data-type='method'><a href="module-api-v1-controller.html#~removeInstance">removeInstance</a></li></ul></li><li><a href="module-api-v2-controller.html">api-v2-controller</a><ul class='methods'><li data-type='method'><a href="module-api-v2-controller.html#~_generateQueryString">_generateQueryString</a></li><li data-type='method'><a href="module-api-v2-controller.html#~_generateWebformUrls">_generateWebformUrls</a></li><li data-type='method'><a href="module-api-v2-controller.html#~_render">_render</a></li><li data-type='method'><a href="module-api-v2-controller.html#~_renderPdf">_renderPdf</a></li><li data-type='method'><a href="module-api-v2-controller.html#~_setDefaultsQueryParam">_setDefaultsQueryParam</a></li><li data-type='method'><a href="module-api-v2-controller.html#~_setGoToHash">_setGoToHash</a></li><li data-type='method'><a href="module-api-v2-controller.html#~_setIframe">_setIframe</a></li><li data-type='method'><a href="module-api-v2-controller.html#~_setPage">_setPage</a></li><li data-type='method'><a href="module-api-v2-controller.html#~_setQuotaUsed">_setQuotaUsed</a></li><li data-type='method'><a href="module-api-v2-controller.html#~_setReturnQueryParam">_setReturnQueryParam</a></li><li data-type='method'><a href="module-api-v2-controller.html#~authCheck">authCheck</a></li><li data-type='method'><a href="module-api-v2-controller.html#~cacheInstance">cacheInstance</a></li><li data-type='method'><a href="module-api-v2-controller.html#~deactivateSurvey">deactivateSurvey</a></li><li data-type='method'><a href="module-api-v2-controller.html#~emptySurveyCache">emptySurveyCache</a></li><li data-type='method'><a href="module-api-v2-controller.html#~getExistingSurvey">getExistingSurvey</a></li><li data-type='method'><a href="module-api-v2-controller.html#~getList">getList</a></li><li data-type='method'><a href="module-api-v2-controller.html#~getNewOrExistingSurvey">getNewOrExistingSurvey</a></li><li data-type='method'><a href="module-api-v2-controller.html#~getNumber">getNumber</a></li><li data-type='method'><a href="module-api-v2-controller.html#~getVersion">getVersion</a></li><li data-type='method'><a href="module-api-v2-controller.html#~removeInstance">removeInstance</a></li></ul></li><li><a href="module-authentication-controller.html">authentication-controller</a><ul class='methods'><li data-type='method'><a href="module-authentication-controller.html#~login">login</a></li><li data-type='method'><a href="module-authentication-controller.html#~logout">logout</a></li><li data-type='method'><a href="module-authentication-controller.html#~setToken">setToken</a></li></ul></li><li><a href="module-cache-model.html">cache-model</a><ul class='methods'><li data-type='method'><a href="module-cache-model.html#.check">check</a></li><li data-type='method'><a href="module-cache-model.html#.flush">flush</a></li><li data-type='method'><a href="module-cache-model.html#.flushAll">flushAll</a></li><li data-type='method'><a href="module-cache-model.html#.get">get</a></li><li data-type='method'><a href="module-cache-model.html#.getHashes">getHashes</a></li><li data-type='method'><a href="module-cache-model.html#.set">set</a></li><li data-type='method'><a href="module-cache-model.html#~_addHashes">_addHashes</a></li><li data-type='method'><a href="module-cache-model.html#~_getKey">_getKey</a></li><li data-type='method'><a href="module-cache-model.html#~cacheManifestItem">cacheManifestItem</a></li></ul></li><li><a href="module-communicator.html">communicator</a><ul class='methods'><li data-type='method'><a href="module-communicator.html#.authenticate">authenticate</a></li><li data-type='method'><a href="module-communicator.html#.getAuthHeader">getAuthHeader</a></li><li data-type='method'><a href="module-communicator.html#.getFormListUrl">getFormListUrl</a></li><li data-type='method'><a href="module-communicator.html#.getManifest">getManifest</a></li><li data-type='method'><a href="module-communicator.html#.getMaxSize">getMaxSize</a></li><li data-type='method'><a href="module-communicator.html#.getSubmissionUrl">getSubmissionUrl</a></li><li data-type='method'><a href="module-communicator.html#.getUpdatedRequestOptions">getUpdatedRequestOptions</a></li><li data-type='method'><a href="module-communicator.html#.getXForm">getXForm</a></li><li data-type='method'><a href="module-communicator.html#.getXFormInfo">getXFormInfo</a></li><li data-type='method'><a href="module-communicator.html#~_findFormAddInfo">_findFormAddInfo</a></li><li data-type='method'><a href="module-communicator.html#~_request">_request</a></li><li data-type='method'><a href="module-communicator.html#~_simplifyFormObj">_simplifyFormObj</a></li><li data-type='method'><a href="module-communicator.html#~_xmlToJson">_xmlToJson</a></li><li data-type='method'><a href="module-communicator.html#~sanitizeHeader">sanitizeHeader</a></li></ul></li><li><a href="module-config-model.html">config-model</a><ul class='members'><li data-type='member'><a href="module-config-model.html#.client">client</a></li><li data-type='member'><a href="module-config-model.html#.server">server</a></li></ul><ul class='methods'><li data-type='method'><a href="module-config-model.html#.getThemesSupported">getThemesSupported</a></li><li data-type='method'><a href="module-config-model.html#~_convertNumbers">_convertNumbers</a></li><li data-type='method'><a href="module-config-model.html#~_convertType">_convertType</a></li><li data-type='method'><a href="module-config-model.html#~_emptyObjectProperties">_emptyObjectProperties</a></li><li data-type='method'><a href="module-config-model.html#~_extractRedisConfigFromUrl">_extractRedisConfigFromUrl</a></li><li data-type='method'><a href="module-config-model.html#~_findNumberIndex">_findNumberIndex</a></li><li data-type='method'><a href="module-config-model.html#~_findSetting">_findSetting</a></li><li data-type='method'><a href="module-config-model.html#~_getEmptyClone">_getEmptyClone</a></li><li data-type='method'><a href="module-config-model.html#~_setRedisConfigFromEnv">_setRedisConfigFromEnv</a></li><li data-type='method'><a href="module-config-model.html#~_updateConfigFromEnv">_updateConfigFromEnv</a></li><li data-type='method'><a href="module-config-model.html#~_updateConfigItemFromEnv">_updateConfigItemFromEnv</a></li></ul></li><li><a href="module-custom-error.html">custom-error</a><ul class='members'><li data-type='member'><a href="module-custom-error.html#.Error">Error</a></li></ul><ul class='methods'><li data-type='method'><a href="module-custom-error.html#.TranslatedError">TranslatedError</a></li></ul></li><li><a href="module-duplicates.html">duplicates</a><ul class='methods'><li data-type='method'><a href="module-duplicates.html#~checkDuplicateEnketoIds">checkDuplicateEnketoIds</a></li><li data-type='method'><a href="module-duplicates.html#~getAllKeys">getAllKeys</a></li><li data-type='method'><a href="module-duplicates.html#~getDuplicates">getDuplicates</a></li><li data-type='method'><a href="module-duplicates.html#~getId">getId</a></li><li data-type='method'><a href="module-duplicates.html#~getSurveyOpenRosaId">getSurveyOpenRosaId</a></li><li data-type='method'><a href="module-duplicates.html#~remove">remove</a></li><li data-type='method'><a href="module-duplicates.html#~removeCache">removeCache</a></li><li data-type='method'><a href="module-duplicates.html#~removeDuplicateEnketoIds">removeDuplicateEnketoIds</a></li></ul></li><li><a href="module-error-handler.html">error-handler</a><ul class='methods'><li data-type='method'><a href="module-error-handler.html#.404">404</a></li><li data-type='method'><a href="module-error-handler.html#.development">development</a></li><li data-type='method'><a href="module-error-handler.html#.production">production</a></li><li data-type='method'><a href="module-error-handler.html#~getErrorMessage">getErrorMessage</a></li></ul></li><li><a href="module-instance-model.html">instance-model</a><ul class='methods'><li data-type='method'><a href="module-instance-model.html#.get">get</a></li><li data-type='method'><a href="module-instance-model.html#.remove">remove</a></li><li data-type='method'><a href="module-instance-model.html#.set">set</a></li></ul></li><li><a href="module-media-controller.html">media-controller</a><ul class='methods'><li data-type='method'><a href="module-media-controller.html#~getMedia">getMedia</a></li></ul></li><li><a href="module-offline-resources-controller.html">offline-resources-controller</a><ul class='methods'><li data-type='method'><a href="module-offline-resources-controller.html#~getScriptContent">getScriptContent</a></li></ul></li><li><a href="module-pages-controller.html">pages-controller</a></li><li><a href="module-pdf.html">pdf</a><ul class='methods'><li data-type='method'><a href="module-pdf.html#.get">get</a></li></ul></li><li><a href="module-router-utils.html">router-utils</a><ul class='members'><li data-type='member'><a href="module-router-utils.html#.idEncryptionKeys">idEncryptionKeys</a></li></ul><ul class='methods'><li data-type='method'><a href="module-router-utils.html#.encryptedEnketoIdSingle">encryptedEnketoIdSingle</a></li><li data-type='method'><a href="module-router-utils.html#.encryptedEnketoIdView">encryptedEnketoIdView</a></li><li data-type='method'><a href="module-router-utils.html#.enketoId">enketoId</a></li><li data-type='method'><a href="module-router-utils.html#~_encryptedEnketoIdParam">_encryptedEnketoIdParam</a></li></ul></li><li><a href="module-submission-model.html">submission-model</a><ul class='methods'><li data-type='method'><a href="module-submission-model.html#.add">add</a></li><li data-type='method'><a href="module-submission-model.html#.isNew">isNew</a></li><li data-type='method'><a href="module-submission-model.html#~_alreadyRecorded">_alreadyRecorded</a></li><li data-type='method'><a href="module-submission-model.html#~_formatter">_formatter</a></li><li data-type='method'><a href="module-submission-model.html#~_getLatestSubmissionIds">_getLatestSubmissionIds</a></li></ul></li><li><a href="module-submissions-controller.html">submissions-controller</a><ul class='methods'><li data-type='method'><a href="module-submissions-controller.html#~_logSubmission">_logSubmission</a></li><li data-type='method'><a href="module-submissions-controller.html#~getInstance">getInstance</a></li><li data-type='method'><a href="module-submissions-controller.html#~maxSize">maxSize</a></li><li data-type='method'><a href="module-submissions-controller.html#~submit">submit</a></li></ul></li><li><a href="module-survey-controller.html">survey-controller</a><ul class='methods'><li data-type='method'><a href="module-survey-controller.html#~_renderWebform">_renderWebform</a></li><li data-type='method'><a href="module-survey-controller.html#~edit">edit</a></li><li data-type='method'><a href="module-survey-controller.html#~offlineWebform">offlineWebform</a></li><li data-type='method'><a href="module-survey-controller.html#~preview">preview</a></li><li data-type='method'><a href="module-survey-controller.html#~redirect">redirect</a></li><li data-type='method'><a href="module-survey-controller.html#~single">single</a></li><li data-type='method'><a href="module-survey-controller.html#~view">view</a></li><li data-type='method'><a href="module-survey-controller.html#~webform">webform</a></li><li data-type='method'><a href="module-survey-controller.html#~xform">xform</a></li></ul></li><li><a href="module-survey-model.html">survey-model</a><ul class='methods'><li data-type='method'><a href="module-survey-model.html#.createNewEnketoId">createNewEnketoId</a></li><li data-type='method'><a href="module-survey-model.html#.get">get</a></li><li data-type='method'><a href="module-survey-model.html#.getId">getId</a></li><li data-type='method'><a href="module-survey-model.html#.getList">getList</a></li><li data-type='method'><a href="module-survey-model.html#.getNumber">getNumber</a></li><li data-type='method'><a href="module-survey-model.html#.incrementSubmissions">incrementSubmissions</a></li><li data-type='method'><a href="module-survey-model.html#.set">set</a></li><li data-type='method'><a href="module-survey-model.html#.update">update</a></li><li data-type='method'><a href="module-survey-model.html#~_404Empty">_404Empty</a></li><li data-type='method'><a href="module-survey-model.html#~_addSurvey">_addSurvey</a></li><li data-type='method'><a href="module-survey-model.html#~_ascendingLaunchDate">_ascendingLaunchDate</a></li><li data-type='method'><a href="module-survey-model.html#~_getActiveSurveys">_getActiveSurveys</a></li><li data-type='method'><a href="module-survey-model.html#~_getEnketoId">_getEnketoId</a></li><li data-type='method'><a href="module-survey-model.html#~_nonEmpty">_nonEmpty</a></li><li data-type='method'><a href="module-survey-model.html#~_updateProperties">_updateProperties</a></li></ul></li><li><a href="module-transformation-controller.html">transformation-controller</a><ul class='methods'><li data-type='method'><a href="module-transformation-controller.html#~_addMediaHash">_addMediaHash</a></li><li data-type='method'><a href="module-transformation-controller.html#~_authenticate">_authenticate</a></li><li data-type='method'><a href="module-transformation-controller.html#~_checkQuota">_checkQuota</a></li><li data-type='method'><a href="module-transformation-controller.html#~_getCombinedHash">_getCombinedHash</a></li><li data-type='method'><a href="module-transformation-controller.html#~_getFormFromCache">_getFormFromCache</a></li><li data-type='method'><a href="module-transformation-controller.html#~_getSurveyParams">_getSurveyParams</a></li><li data-type='method'><a href="module-transformation-controller.html#~_respond">_respond</a></li><li data-type='method'><a href="module-transformation-controller.html#~_setCookieAndCredentials">_setCookieAndCredentials</a></li><li data-type='method'><a href="module-transformation-controller.html#~_updateCache">_updateCache</a></li><li data-type='method'><a href="module-transformation-controller.html#~getSurveyHash">getSurveyHash</a></li><li data-type='method'><a href="module-transformation-controller.html#~getSurveyParts">getSurveyParts</a></li></ul></li><li><a href="module-user-model.html">user-model</a><ul class='methods'><li data-type='method'><a href="module-user-model.html#.getCredentials">getCredentials</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.areOwnPropertiesEqual">areOwnPropertiesEqual</a></li><li data-type='method'><a href="module-utils.html#.cleanUrl">cleanUrl</a></li><li data-type='method'><a href="module-utils.html#.getOpenRosaKey">getOpenRosaKey</a></li><li data-type='method'><a href="module-utils.html#.getXformsManifestHash">getXformsManifestHash</a></li><li data-type='method'><a href="module-utils.html#.insecureAes192Decrypt">insecureAes192Decrypt</a></li><li data-type='method'><a href="module-utils.html#.insecureAes192Encrypt">insecureAes192Encrypt</a></li><li data-type='method'><a href="module-utils.html#.isValidUrl">isValidUrl</a></li><li data-type='method'><a href="module-utils.html#.md5">md5</a></li><li data-type='method'><a href="module-utils.html#.pickRandomItemFromArray">pickRandomItemFromArray</a></li><li data-type='method'><a href="module-utils.html#.randomString">randomString</a></li><li data-type='method'><a href="module-utils.html#~_getKeyIv">_getKeyIv</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#createMediaURL">createMediaURL</a></li><li><a href="global.html#EnketoRecord">EnketoRecord</a></li><li><a href="global.html#escapeFileName">escapeFileName</a></li><li><a href="global.html#escapeURL">escapeURL</a></li><li><a href="global.html#getHostURL">getHostURL</a></li><li><a href="module-communicator.html#.getManifest">getManifest</a></li><li><a href="global.html#getMediaMap">getMediaMap</a></li><li><a href="global.html#getSurveyInfo">getSurveyInfo</a></li><li><a href="global.html#HostURLOptions">HostURLOptions</a></li><li><a href="global.html#matchMediaURLSegments">matchMediaURLSegments</a></li><li><a href="global.html#MediaURLOptions">MediaURLOptions</a></li><li><a href="global.html#MediaURLSegments">MediaURLSegments</a></li><li><a href="global.html#rebuildMediaURLCache">rebuildMediaURLCache</a></li><li><a href="global.html#rebuildMediaURLCachePromises">rebuildMediaURLCachePromises</a></li><li><a href="global.html#ResourceType">ResourceType</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">app/models/config-model.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module config-model
 */

const config = require('../../config/default-config');
const pkg = require('../../package.json');
const mergeWith = require('lodash/mergeWith');
const path = require('path');
const fs = require('fs');
const url = require('url');

const themePath = path.join(__dirname, '../../public/css');
const languagePath = path.join(__dirname, '../../locales/src');
const pkgDir = require('pkg-dir');
const { execSync } = require('child_process');
// var debug = require( 'debug' )( 'config-model' );

// Merge default and local config files if a local config.json file exists
try {
    const localConfigJSON = String(
        fs.readFileSync(path.resolve(process.cwd(), './config/config.json'))
    );
    const localConfig = JSON.parse(localConfigJSON);

    mergeWith(config, localConfig, (objValue, srcValue) => {
        if (Array.isArray(srcValue)) {
            // Overwrite completely if value in localConfig is an array (do not merge arrays)
            return srcValue;
        }
    });
} catch (err) {
    // Override default config with environment variables if a local config.json does not exist
    console.warn(
        'No local config.json found. Will check environment variables instead.'
    );
    _updateConfigFromEnv(config);
    _setRedisConfigFromEnv();
}

/**
 * Updates all configuration items for which an environment variable was set.
 */
function _updateConfigFromEnv() {
    const envVarNames = [];

    for (const envVarName in process.env) {
        if (
            Object.prototype.hasOwnProperty.call(process.env, envVarName) &amp;&amp;
            envVarName.indexOf('ENKETO_') === 0
        ) {
            envVarNames.push(envVarName);
        }
    }

    envVarNames.sort().forEach(_updateConfigItemFromEnv);
}

/**
 * Updates a configuration item that corresponds to the provided environment variable name.
 *
 * @param { string } envVarName - environment variable name
 */
function _updateConfigItemFromEnv(envVarName) {
    const parts = envVarName.split('_').slice(1).map(_convertNumbers);
    let nextNumberIndex = _findNumberIndex(parts);
    let proceed = true;
    let part;
    let settingArr;
    let setting;
    let propName;

    while (proceed) {
        proceed = false;
        part = parts.slice(0, nextNumberIndex).join('_');
        settingArr = _findSetting(config, part);
        if (settingArr) {
            setting = settingArr[0];
            propName = settingArr[1];
            if (!Array.isArray(setting[propName])) {
                setting[propName] = _convertType(process.env[envVarName]);
            } else if (nextNumberIndex === parts.length - 1) {
                // simple populate array item (simple value)
                setting[propName][parts[nextNumberIndex]] =
                    process.env[envVarName];
            } else if (
                typeof setting[propName][parts[nextNumberIndex]] !== 'undefined'
            ) {
                // this array item (object) already exists
                nextNumberIndex = _findNumberIndex(parts, nextNumberIndex + 1);
                proceed = true;
            } else {
                // clone previous array item (object) and empty all property values
                setting[propName][parts[nextNumberIndex]] = _getEmptyClone(
                    setting[propName][parts[nextNumberIndex] - 1]
                );
                proceed = true;
            }
        }
    }
}

/**
 * Converts stringified booleans and `null` to original types
 *
 * @param { string } str - A thing to be converted.
 * @return {string|boolean|null} an un-stringified value or input value itself
 */
function _convertType(str) {
    switch (str) {
        case 'true':
            return true;
        case 'false':
            return false;
        case 'null':
            return null;
        default:
            return str;
    }
}

/**
 * Searches the configuration object to find a match for an environment variable,
 * or the first part of such a variable.
 *
 * @param { object } obj - Configuration object
 * @param { string } envName - Environment variable name or the first part of one
 * @param { string } prefix - Prefix to use (for nested objects)
 * @return {{0: object, 1: string}} 2-item array of object and property name
 */
function _findSetting(obj, envName, prefix = '') {
    for (const prop in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, prop)) {
            const propEnvStyle = prefix + prop.replace(/ /g, '_').toUpperCase();
            if (propEnvStyle === envName) {
                return [obj, prop];
            }
            if (typeof obj[prop] === 'object' &amp;&amp; obj[prop] !== null) {
                const found = _findSetting(
                    obj[prop],
                    envName,
                    `${propEnvStyle}_`
                );
                if (found) {
                    return found;
                }
            }
        }
    }
}

/**
 * Convert a non-empty string number to a number.
 *
 * @param { string } str - A stringified number
 * @return {string|number} an input value or unstrigified number
 */
function _convertNumbers(str) {
    if (!str) {
        return str;
    }
    const converted = Number(str);

    return !isNaN(converted) ? converted : str;
}

/**
 * Finds the index of the first array item that is a number.
 *
 * @param {Array&lt;string|number>} arr - Array of strings and numbers
 * @param { number } [start] - Start index
 * @return {number|undefined} The found index
 */
function _findNumberIndex(arr, start = 0) {
    let i;
    arr.some((val, index) => {
        if (typeof val === 'number' &amp;&amp; index >= start) {
            i = index;

            return true;
        }
    });

    return i;
}

/**
 * Returns an empty clone of the provided simple object
 *
 * @param { object } obj - A simple object
 * @return { object } Clone of input object with emptied properties
 */
function _getEmptyClone(obj) {
    const clone = JSON.parse(JSON.stringify(obj));
    _emptyObjectProperties(clone);

    return clone;
}

/**
 * Replaces all non-null and non-object property values with empty string.
 *
 * @param { object } obj - A simple object
 */
function _emptyObjectProperties(obj) {
    for (const prop in obj) {
        // if a simple array of string values
        if (Array.isArray(obj[prop]) &amp;&amp; typeof obj[prop][0] === 'string') {
            obj[prop] = [];
        } else if (typeof obj[prop] === 'object' &amp;&amp; obj[prop] !== null) {
            _emptyObjectProperties(obj[prop]);
        } else if (obj[prop]) {
            obj[prop] = ''; // let's hope this has no side-effects
        }
    }
}

/**
 * Overrides any redis settings if a special enviroment URL variable is set.
 */
function _setRedisConfigFromEnv() {
    const redisMainUrl = process.env.ENKETO_REDIS_MAIN_URL;
    const redisCacheUrl = process.env.ENKETO_REDIS_CACHE_URL;

    if (redisMainUrl) {
        config.redis.main = _extractRedisConfigFromUrl(redisMainUrl);
    }
    if (redisCacheUrl) {
        config.redis.cache = _extractRedisConfigFromUrl(redisCacheUrl);
    }
}

/**
 * Parses a redis URL and returns an object with `host`, `port` and `password` properties.
 *
 * @param { string } redisUrl - A compliant redis url
 * @return {{host: string, port: string, password: string|null}} config object
 */
function _extractRedisConfigFromUrl(redisUrl) {
    const parsedUrl = url.parse(redisUrl);
    const password =
        parsedUrl.auth &amp;&amp; parsedUrl.auth.split(':')[1]
            ? parsedUrl.auth.split(':')[1]
            : null;

    return {
        host: parsedUrl.hostname,
        port: parsedUrl.port,
        password,
    };
}

/**
 * Returns a list of supported themes,
 * in case a list is provided only the ones that exists are returned.
 *
 * @static
 * @param {Array&lt;string>} themeList - A list of themes e.g `['formhub', 'grid']`
 * @return {Array&lt;string>} An list of supported theme names
 */
function getThemesSupported(themeList) {
    const themes = [];

    if (fs.existsSync(themePath)) {
        fs.readdirSync(themePath).forEach((file) => {
            const matches = file.match(/^theme-([A-z-]+)\.css$/);
            if (matches &amp;&amp; matches.length > 1) {
                if (themeList !== undefined &amp;&amp; themeList.length) {
                    if (themeList.indexOf(matches[1]) !== -1) {
                        themes.push(matches[1]);
                    }
                } else {
                    themes.push(matches[1]);
                }
            }
        });
    }

    return themes;
}

try {
    // need to be in the correct directory to run git describe --tags
    config.version = String(
        execSync(`cd ${__dirname}; git describe --tags`, {
            encoding: 'utf-8',
        })
    ).trim();
} catch (e) {
    // Probably not deployed with git, try special .tag.txt file
    try {
        config.version = `${String(execSync('head -1 .tag.txt')).trim()}-r`;
    } catch (e) {
        // no .tag.txt present, use package.json version
        config.version = `${pkg.version}-p`;
    }
}

// detect supported themes
config['themes supported'] = getThemesSupported(config['themes supported']);

// detect supported languages
config['languages supported'] = fs
    .readdirSync(languagePath)
    .filter(
        (file) =>
            file.indexOf('.') !== 0 &amp;&amp;
            fs.statSync(path.join(languagePath, file)).isDirectory()
    );

// if necessary, correct the base path to use for all routing
if (config['base path'] &amp;&amp; config['base path'].indexOf('/') !== 0) {
    config['base path'] = `/${config['base path']}`;
}
if (
    config['base path'] &amp;&amp;
    config['base path'].lastIndexOf('/') === config['base path'].length - 1
) {
    config['base path'] = config['base path'].substring(
        0,
        config['base path'].length - 1
    );
}
config['offline path'] = '/x';

config.root = pkgDir.sync(__dirname);

// ensure backwards compatibility of old external authentication configurations
const { authentication } = config['linked form and data server'];
if (
    authentication['managed by enketo'] === false &amp;&amp;
    authentication['external login url that sets cookie']
) {
    authentication.type = 'cookie';
    authentication.url = authentication['external login url that sets cookie'];
}
delete authentication['external login url that sets cookie'];
delete authentication['managed by enketo'];

if (config['id length'] &lt; 4) {
    config['id length'] = 4;
} else if (config['id length'] > 31) {
    config['id length'] = 31;
}

module.exports = {
    /**
     * @type { object }
     */
    server: config,
    /**
     * @type { object }
     */
    client: {
        googleApiKey: config.google['api key'],
        maps: config.maps,
        modernBrowsersURL: 'modern-browsers',
        supportEmail: config.support.email,
        themesSupported: config['themes supported'],
        defaultTheme: config['default theme'],
        languagesSupported: config['languages supported'],
        timeout: config.timeout,
        submissionParameter: {
            name: config['query parameter to pass to submission'],
        },
        basePath: config['base path'],
        repeatOrdinals: config['repeat ordinals'],
        validateContinuously: config['validate continuously'],
        validatePage: config['validate page'],
        swipePage: config['swipe page'],
        textMaxChars: config['text field character limit'],
        csrfCookieName: config['csrf cookie name'],
        excludeNonRelevant: config['exclude non-relevant'],
        experimentalOptimizations: config['experimental optimizations'],
    },
    getThemesSupported,
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
